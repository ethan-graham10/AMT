
#!/bin/bash
#Script Name: ATM
#This script only holds up to 9999 bank accounts
miniStatement() {
        cat << EOF
        Account Name: $(grep $inputAcctNum accountsFile | cut -d":" -f2)
        Account Number: $currentAcctNum
        Date: $(date +%D)
        Time: $(date +%R)
EOF

while read line
do
        echo $line
done < "$(transactionHistories/$currentAcctNum)"


        #decide on formating
        #Put me in the EOF:::Account Balance: $(cat transactionHistories/$currentAcctNum | head -1 | cut -d":" -f2 | tr -d "[:space:]")
        #cat transactionHistories/$currentAcctNum | grep -w -v Balance
        #cat transactionHistories/$currentAcctNum
}

deposit() {
          read -p "How much would you like to deposit?: " depoAmt
                if [[ $depoAmt =~ ^[0-9]+$ ]] ; then
                balance=$(cat transactionHistories/$currentAcctNum | head -1 | cut -d":" -f2 | tr -d "[:space:]")
                        newBalance=$(($balance + $depoAmt));
                else
                        echo Please input a valid option
                        depoAmt;
                fi

  echo "Balance: $newBalance" > transactionHistories/"new"$currentAcctNum
        cat transactionHistories/$currentAcctNum | grep -w -v Balance >> transactionHistories/"new"$currentAcctNum
        rm transactionHistories/$currentAcctNum
        mv transactionHistories/"new"$currentAcctNum transactionHistories/$currentAcctNum
        echo +$depoAmt >> transactionHistories/$currentAcctNum

        echo Deposit Complete
}

withdraw() {
        cat << EOF

        How much would you like to withdraw? Please input option exactly as you see it.
        \$10, \$20, \$50, \$100, \$200, Other amount(simply input number), Back to main
EOF

        read -p ":" wdAmt

        balance=$(cat transactionHistories/$currentAcctNum | head -1 | cut -d":" -f2 | tr -d "[:space:]")

        if [[ $wdAmt =~ ^[0-9]+$ || $wdAmt = "Back to main" ]] ; then
        ###############we are here in the above if. make sure that if the initial deposit is 100, withdraw 20 works
                if [[ $wdAmt = "Back to main" ]] ; then
                        userMenu;
                elif [[ $wdAmt -gt $balance ]] ; then
                        echo "Please input a number that won't overdraft your account"
                        withdraw;
                else
                        newBalance=$(($balance - $wdAmt))
                fi
        else
                echo Please input a valid option
                withdraw;
        fi

  echo "Balance: $newBalance" > transactionHistories/"new"$currentAcctNum
        cat transactionHistories/$currentAcctNum | grep -w -v Balance >> transactionHistories/"new"$currentAcctNum
        rm transactionHistories/$currentAcctNum
        mv transactionHistories/"new"$currentAcctNum transactionHistories/$currentAcctNum
  echo -$wdAmt >> transactionHistories/$currentAcctNum
}

userMenu() {
        currentAcctNum=$1
        name=$(grep $inputAcctNum accountsFile | cut -d":" -f2)

        cat << EOF

  Welcome $name
        1) Display Balance
        2) Withdraw funds
        3) Deposit Funds
        4) Mini Statement
        5) Logout
EOF

        echo Please enter the corresponding number to the option you want
        read -p ":" option

        case $option in
                "1")
                        echo " "
                        echo $(cat transactionHistories/$currentAcctNum | head -1)
                        userMenu $currentAcctNum;;
                "2")
                        withdraw $currentAcctNum
                        userMenu $currentAcctNum;;
                "3")
                        deposit $currentAcctNum
                        userMenu $currentAcctNum;;
                "4")
                        miniStatement $currentAcctNum
                        userMenu $currentAcctNum;;
                "5")
                        welcomeScreen;;
                *)
                        echo " "
                        userMenu $currentAcctNum;;
        esac
}

userLogin() {
        read -p "Enter your accountNumber: " inputAcctNum
        actualAcctNum=$(cut -d":" -f3 accountsFile | grep -w $inputAcctNum)
        while [[ $actualAcctNum = "" ]]
        do
                read -p "Please enter a valid accountNumber: " inputAcctNum
                actualAcctNum=$(cut -d":" -f3 accountsFile | grep -w $inputAcctNum)
        done

        read -p "Enter your pin: " inputAcctPin
        actualAcctPin=$(grep $inputAcctNum  accountsFile | cut -d":" -f1)
        while [[ ! $actualAcctPin -eq inputAcctPin ]]
        do
                read -p "Enter your pin CORRECTLY: " inputAcctPin
                #actualAcctPin=$(grep $inputAcctPin  accountsFile | cut -d":" -f1)
        done

  userMenu $inputAcctNum
}

makeNewUser() {
        if [ ! -d ./transactionHistories ] ; then
                mkdir transactionHistories
        fi

        userPin=0

        read -p "Enter your first name: " firstName
        read -p "Enter your last name: " lastName
        fullName="$firstName""_""$lastName"

        read -p "Enter your initial deposit ammount: " depositAmt
        while [[ $userPin -lt 1000 || $userPin -gt 9999 ]]
        do
                echo  "Enter the 4 digit pin you will like to use"
                read userPin </dev/tty
        done

        userAcctNum=$(shuf -i 1000-9999 -n 1)
        userAcctNum=$(($userAcctNum + 10010000))

        echo "Your account number is: $userAcctNum please remember it!"
        echo "$userPin:$fullName:$userAcctNum:$depositAmt" >> accountsFile

        userTransactions="$userAcctNum" #need to add A at the end it so it doesn't grab balance else
        #echo $userTransactions
        touch transactionHistories/$userTransactions
        echo "Balance: $depositAmt" >> transactionHistories/$userTransactions
        echo "+$depositAmt" >> transactionHistories/$userTransactions
}

welcomeScreen() {
        echo Which would you like to do, Please input exactly as you see it?
        echo New User
        echo Existing User
        echo Exit ATM
        read -p ":" userAns

        echo $userAns

        case $userAns in
                "New User")
                        makeNewUser
                        welcomeScreen;;
                "Existing User")
                        userLogin ;;
                "Exit ATM")
                        exit;;
                *)
                        echo " "
                        echo "Please input a valid option"
                        welcomeScreen;;
        esac
}

startATM() {
        welcomeScreen
}

startATM
